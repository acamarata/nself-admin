name: Sync Documentation to Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -f "docs/VERSION" ]; then
            VERSION=$(cat docs/VERSION | tr -d '\n')
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Syncing docs for version: $VERSION"

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone Wiki
        run: |
          git clone https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki || {
            echo "Wiki doesn't exist yet, creating..."
            mkdir wiki
            cd wiki
            git init
          }

      - name: Sync Documentation
        run: |
          # Clear existing wiki content (except .git)
          find wiki -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true

          # Copy all docs to wiki root
          cp -r docs/* wiki/

          # Create footer with version info
          cat > wiki/_Footer.md << EOF
          ---
          **Version:** ${{ steps.version.outputs.version }} | **Updated:** $(date -u +"%Y-%m-%d %H:%M UTC") | [GitHub](https://github.com/${{ github.repository }})
          EOF

          # Create comprehensive sidebar navigation
          cat > wiki/_Sidebar.md << 'SIDEBAR'
          ## Navigation

          **[Home](Home)**

          ---

          ### Getting Started
          * [Quick Start](Quick-Start)
          * [Init Wizard Guide](Init-Wizard-Guide)
          * [Dashboard Overview](Dashboard-Overview)

          ### Core Features
          * [Architecture](Architecture)
          * [Service Configuration](Service-Configuration)
          * [Database Management](Database-Management)
          * [Monitoring](Monitoring)
          * [Build Process](Build-Process)

          ### Reference
          * [API Reference](API)
          * [Environment Variables](ENVIRONMENT_VARIABLES)
          * [CLI Integration](CLI_INTEGRATION)

          ### Deployment
          * [Production Deployment](Production-Deployment)
          * [Updates](Updates)
          * [CI Setup](CI_SETUP)

          ### Help & Support
          * [FAQ](FAQ)
          * [Troubleshooting](TROUBLESHOOTING)
          * [Security](SECURITY)

          ---

          ### Meta
          * [Changelog](CHANGELOG)
          * [License](LICENSE)
          SIDEBAR

      - name: Commit and Push Wiki
        working-directory: wiki
        run: |
          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync docs v${{ steps.version.outputs.version }} from main"
            git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git || {
              echo "Push failed - wiki may not be initialized"
              echo "Please create the wiki manually first by visiting:"
              echo "https://github.com/${{ github.repository }}/wiki"
            }
            echo "Wiki updated successfully!"
          fi
