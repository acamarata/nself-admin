name: Lighthouse Audit

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'

jobs:
  audit:
    name: Performance Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Start application
        run: |
          pnpm start &
          echo "Waiting for app to start..."
          sleep 10
          curl --retry 5 --retry-delay 2 http://localhost:3021/api/health

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3021
            http://localhost:3021/login
            http://localhost:3021/services
            http://localhost:3021/database
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Run Lighthouse audit
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: http://localhost:3021
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Parse Lighthouse scores
        id: scores
        run: |
          # Extract scores from Lighthouse results
          performance=$(jq -r '.[] | select(.url | contains("localhost:3021")) | .summary.performance * 100' lighthouse-results.json || echo "0")
          accessibility=$(jq -r '.[] | select(.url | contains("localhost:3021")) | .summary.accessibility * 100' lighthouse-results.json || echo "0")
          bestPractices=$(jq -r '.[] | select(.url | contains("localhost:3021")) | .summary["best-practices"] * 100' lighthouse-results.json || echo "0")
          seo=$(jq -r '.[] | select(.url | contains("localhost:3021")) | .summary.seo * 100' lighthouse-results.json || echo "0")

          echo "performance=$performance" >> $GITHUB_OUTPUT
          echo "accessibility=$accessibility" >> $GITHUB_OUTPUT
          echo "bestPractices=$bestPractices" >> $GITHUB_OUTPUT
          echo "seo=$seo" >> $GITHUB_OUTPUT

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const performance = ${{ steps.scores.outputs.performance }};
            const accessibility = ${{ steps.scores.outputs.accessibility }};
            const bestPractices = ${{ steps.scores.outputs.bestPractices }};
            const seo = ${{ steps.scores.outputs.seo }};

            const getEmoji = (score) => {
              if (score >= 90) return 'ðŸŸ¢';
              if (score >= 50) return 'ðŸŸ ';
              return 'ðŸ”´';
            };

            const body = `## Lighthouse Audit Results

            | Category | Score | Status |
            |----------|-------|--------|
            | Performance | ${performance} | ${getEmoji(performance)} |
            | Accessibility | ${accessibility} | ${getEmoji(accessibility)} |
            | Best Practices | ${bestPractices} | ${getEmoji(bestPractices)} |
            | SEO | ${seo} | ${getEmoji(seo)} |

            ### Score Guide
            - ðŸŸ¢ 90-100: Good
            - ðŸŸ  50-89: Needs improvement
            - ðŸ”´ 0-49: Poor

            [View full Lighthouse report](${{ steps.lighthouse.outputs.links }})
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: |
            .lighthouseci/
            lighthouse-results.json
          retention-days: 30

      - name: Fail on poor performance
        if: steps.scores.outputs.performance < 50
        run: |
          echo "::error::Performance score below threshold: ${{ steps.scores.outputs.performance }}"
          exit 1
